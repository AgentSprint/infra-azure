name: New Infra (POC)

on:
  workflow_dispatch:
    inputs:
      client_code:
        description: 'Client code to deploy'
        required: true
        type: string
      location:
        description: 'Location to deploy the client code'
        required: true
        type: string
      issue_api_url:
        description: 'URL of the issue to update'
        required: true
        type: string

permissions:
  contents: read
  issues: write   # required to comment

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID:        ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET:    ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID:        ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID:  ${{ secrets.ARM_SUBSCRIPTION_ID }}
      GH_TOKEN:             ${{ secrets.GH_TOKEN }}
    steps:
      - name: Echo received inputs
        run: |
          echo "===== New Infra POC ====="
          echo "Client code: ${{ inputs.client_code }}"
          echo "Location: ${{ inputs.location }}"
          echo "Issue API URL: ${{ inputs.issue_api_url }}"

      - name: Comment back to the request issue
        uses: AgentSprint/utils-actions/issues/comment-on@main
        with:
            issue_api_url: ${{ inputs.issue_api_url }}
            body: |
                âœ… Infra workflow received values:
                - client_code: ${{ inputs.client_code }}
                - location: ${{ inputs.location }}

                next action: Deploy the client code to the specified location
            token: ${{ secrets.GH_TOKEN }}
      
      - name: terraform init
        run: |
          echo "Initializing Terraform..."
          terraform init
        working-directory: terraform

      - name: terraform plan
        run: |
          echo "Planning Terraform configuration..."
          terraform plan -var="client_code=${{ inputs.client_code }}" -var="location=${{ inputs.location }}"
        working-directory: terraform

      - name: terraform apply
        run: |  
          echo "Applying Terraform configuration..."
          terraform apply -auto-approve -var="client_code=${{ inputs.client_code }}" -var="location=${{ inputs.location }}" | tee tf-apply-output.txt
        working-directory: terraform
        
      - name: Comment terraform apply result to the request issue
        uses: AgentSprint/utils-actions/issues/comment-on@main
        with:
          issue_api_url: ${{ inputs.issue_api_url }}
          body: |
            ðŸš€ Terraform apply result for client_code: ${{ inputs.client_code }}, location: ${{ inputs.location }}:

            ```
            ${{ steps.terraform_apply.outputs.result }}
            ```
          token: ${{ secrets.GH_TOKEN }}            