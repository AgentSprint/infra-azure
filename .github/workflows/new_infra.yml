name: New Infra (POC)

on:
  workflow_dispatch:
    inputs:
      client_name:
        description: 'Client Name to deploy'
        required: true
        type: string
      client_code:
        description: 'Client code to deploy'
        required: true
        type: string
      location:
        description: 'Location to deploy the client code'
        required: true
        type: string
      issue_api_url:
        description: 'URL of the issue to update'
        required: true
        type: string

permissions:
  contents: read
  issues: write   # required to comment

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID:        ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET:    ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID:        ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID:  ${{ secrets.ARM_SUBSCRIPTION_ID }}
      GH_TOKEN:             ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Comment back to the request issue
        uses: AgentSprint/utils-actions/issues/comment-on@main
        with:
            issue_api_url: ${{ inputs.issue_api_url }}
            body: |
                âœ… Infra workflow received values:
                - client_code: ${{ inputs.client_code }}
                - location: ${{ inputs.location }}
            token: ${{ secrets.GH_TOKEN }}

      - name: create a new branch for the client
        run: |
            git checkout -b "adding_new_client_${{ inputs.client_code }}"
      
      - name: creating client name folder under client if not exist
        run: |
          if [ ! -d "clients/${{ inputs.client_name }}" ]; then
            mkdir -p "clients/${{ inputs.client_name }}"
          fi
      - name: create a new file client_code.txt, replace if old exists
        run: |
          echo "# terraform.tfvars" > "clients/${{ inputs.client_name }}/${{ inputs.client_code }}.tfvars"
          echo "" >> "clients/${{ inputs.client_name }}/${{ inputs.client_code }}.tfvars"
          echo "client_code = \"${{ inputs.client_code }}\"" >> "clients/${{ inputs.client_name }}/${{ inputs.client_code }}.tfvars"
          echo "location = \"${{ inputs.location }}\"" >> "clients/${{ inputs.client_name }}/${{ inputs.client_code }}.tfvars"

      - name: commit the branch
        id: git_commit_push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Add new client ${{ inputs.client_name }} with code ${{ inputs.client_code }}"
          git push --set-upstream origin "adding_new_client_${{ inputs.client_code }}"

      - name: check git status
        id: git_status
        run: |
          STATUS="$(git status)"
          echo "$STATUS"
          if echo "$STATUS" | grep -q "nothing to commit, working tree clean"; then
            echo "clean=true" >> $GITHUB_OUTPUT
          else
            echo "clean=false" >> $GITHUB_OUTPUT
          fi

      - name: Echo
        if: steps.git_status.outputs.clean == 'false'
        run: |
            echo "âœ… Infra already exists"
            echo "No changes required"

      - name: Update issue and exit if infra already exists
        if: steps.git_status.outputs.clean == 'false'
        uses: AgentSprint/utils-actions/issues/comment-on@main
        with:
            issue_api_url: ${{ inputs.issue_api_url }}
            body: |
                âœ… Infra already exists
            token: ${{ secrets.GH_TOKEN }}

      - name: create a pull request
        if: steps.git_status.outputs.clean == 'true'
        id: create_pr
        uses: AgentSprint/utils-actions/pull_request/create@main
        with:
            owner: "AgentSprint"
            repo: "infra-azure"
            title: "Add new client :${{ inputs.client_name }} (${{ inputs.client_code }})"
            issue_api_url: ${{ inputs.issue_api_url }}
            client_name: ${{ inputs.client_name }}
            client_code: ${{ inputs.client_code }}
            location: ${{ inputs.location }}
            tfvars_filepath: "clients/${{ inputs.client_name }}/${{ inputs.client_code }}.tfvars"
            base: main
            head: "adding_new_client_${{ inputs.client_code }}"
            token: ${{ secrets.GH_TOKEN }}

      - name: echo
        if: steps.git_status.outputs.clean == 'true'
        run: |
          echo "âœ… Pull request created"
          echo "PR URL: ${{ steps.create_pr.outputs.pr_number }}"



      - name: Set up Terraform
        if: steps.git_status.outputs.clean == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: terraform init
        if: steps.git_status.outputs.clean == 'true'
        run: |
          echo "Initializing Terraform..."
          terraform init
        working-directory: terraform

      - name: terraform plan
        if: steps.git_status.outputs.clean == 'true'
        id: tfplan
        working-directory: terraform
        run: |
          set -o pipefail
          terraform plan -input=false -out=tfplan -var-file=../clients/${{ inputs.client_name }}/${{ inputs.client_code }}.tfvars
        continue-on-error: true

      - name: Merge a pull request
        if: steps.git_status.outputs.clean == 'true'
        uses: AgentSprint/utils-actions/pull_request/merge@main
        with:
            owner: "AgentSprint"
            repo: "infra-azure"
            pr_number: "${{ steps.create_pr.outputs.pr_number }}"
            token: ${{ secrets.GH_TOKEN }}

      - name: delete branch
        if: steps.git_status.outputs.clean == 'true'
        uses: AgentSprint/utils-actions/repo/branch/delete@main
        with:
            owner: "AgentSprint"
            repo: "infra-azure"
            branch_name: "adding_new_client_${{ inputs.client_code }}"
            token: ${{ secrets.GH_TOKEN }}

      - name: terraform apply
        if: steps.git_status.outputs.clean == 'true'
        id: tfapply
        working-directory: terraform
        run: |
          set -o pipefail
          terraform apply -auto-approve -input=false -out=tfplan -var-file=../clients/${{ inputs.client_name }}/${{ inputs.client_code }}.tfvars
        continue-on-error: true


      # One summary comment (always), includes the link
      - name: Report Terraform status to issue
        if: steps.git_status.outputs.clean == 'true'
        uses: AgentSprint/utils-actions/issues/comment-on@main
        with:
          issue_api_url: ${{ inputs.issue_api_url }}
          body: |
            ğŸ“ Terraform summary for **${{ inputs.client_code }}** @ **${{ inputs.location }}**:

            - Plan:  ${{ steps.tfplan.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}
            - Apply: ${{ steps.tfapply.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}

            ${{ (steps.tfplan.outcome != 'success' || steps.tfapply.outcome != 'success') && format('ğŸ”— Run details: ', env.RUN_URL) || '' }}
          token: ${{ secrets.GH_TOKEN }}

      # Finally, fail the job if either step failed
      - name: Fail job if Terraform failed
        if: steps.tfplan.outcome != 'success' || steps.tfapply.outcome != 'success'
        run: exit 1

      - name: close request issue
        if: always()
        uses: AgentSprint/utils-actions/issues/close@main
        with:
            issue_api_url: ${{ inputs.issue_api_url }}
            token: ${{ secrets.GH_TOKEN }}
